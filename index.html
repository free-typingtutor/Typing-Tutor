<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="google-site-verification" content="iuiY8HTPiNJUT7fEcpvl2h1kZGYUR8VUc-HbkUartT8" />
  <title>Typing Tutor – Typing Test</title>
  <link rel="shortcut icon" href="shortcuticon.png" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="styles.css"/>
  <style>
      :root {
    --bg: #0b1020;
    --bg-soft: #121831;
    --card: #141b38;
    --text: #ffffff;
    --muted: #9aa3c7;
    --brand: #6aa6ff;
    --good: #16c172;
    --bad: #ff5d6c;
    --warn: #ffc857;
    --key: #1c244a;
    --key-border: #2c3561;
    --key-text: #e8ecff;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  [data-theme="light"]{
    --bg: #f6f7fb;
    --bg-soft: #eef0f6;
    --card: #ffffff;
    --text: #000000;
    --muted: #5b6383;
    --brand: #2f68ff;
    --good: #119b5f;
    --bad: #d83e4b;
    --warn: #c28a08;
    --key: #f1f3fb;
    --key-border: #d8def0;
    --key-text: #151a2d;
    --shadow: 0 10px 30px rgba(0,0,0,.08);
  }

  * { box-sizing: border-box; }
  html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
  a { color: var(--brand); text-decoration: none; }
  a:hover { text-decoration: underline; }

  .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }

  /* Header */
  header {
    display:flex; align-items:center; justify-content:space-between; gap:16px;
    position: sticky; top:0; z-index: 50; background:linear-gradient(180deg, var(--bg) 80%, transparent);
    padding-block: 8px 6px;
  }
  .logo {
    display:flex; align-items:center; gap:12px;
  }
  .logo img {
    height:48px; width:auto; display:block; border-radius:10px; box-shadow: var(--shadow);
    background: var(--bg-soft); object-fit: contain; padding: 6px;
  }
  .controls { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
  .file-input {
    font-size: 12px; color: var(--muted);
  }
  .toggle {
    display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none;
    background: var(--card); border:1px solid var(--key-border); border-radius: 999px; padding:6px 12px;
    box-shadow: var(--shadow);
  }
  .toggle input { accent-color: var(--brand); transform: translateY(1px); }

  /* Main grid */
  .grid {
    align-self: center;
    max-width: 1200px;
    margin: 0 auto;
    padding: 16px;
    display:grid; gap:16px; grid-template-columns: 1.1fr .9fr;
  }
  @media (max-width: 980px) {
    .grid { grid-template-columns: 1fr; }
  }

  /* Cards */
  .card {
    background: var(--card); border:1px solid var(--key-border); border-radius: 16px; padding: 16px;
    box-shadow: var(--shadow);max-width: 700px;margin: auto;
  }
  .card1 {
    background: var(--card); border:1px solid var(--key-border); border-radius: 16px; padding: 16px;
    box-shadow: var(--shadow);max-width: 700px;margin: auto;height: 100%;
  }
  .card h2 { margin:0 0 10px; font-size: 18px; }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .row .spacer { flex:1; }

  /* Buttons & selects */
  .btn {
    background: linear-gradient(180deg, var(--brand), color-mix(in oklab, var(--brand) 88%, black 12%));
    color: white; border:none; border-radius: 10px; padding: 10px 14px; cursor:pointer;
    box-shadow: var(--shadow); font-weight: 600;
  }
  .btn.secondary {
    background: var(--bg-soft); color: var(--text); border:1px solid var(--key-border);
  }
  .btn.ghost {
    background: transparent; color: var(--text); border:1px dashed var(--key-border);
  }
  .btn:disabled { opacity: .5; cursor: not-allowed; }

  select, .pill {
    background: var(--bg-soft); color: var(--text); border:1px solid var(--key-border);
    border-radius: 10px; padding: 8px 12px;
  }
  .pill { display:inline-flex; align-items:center; gap:8px; }

  /* Prompt & typing area */
  .prompt {
    width: 100%;
  height: 110px;
  resize: none;
  font: 16px/1.5 ui-monospace, "SF Mono", Menlo, Consolas, monospace;
  background: var(--bg-soft);
  color: var(--text);
  border: 1px solid var(--key-border);
  border-radius: 12px;
  padding: 12px;
  white-space: pre-wrap;
  overflow-y: auto;
  word-wrap: break-word;
  overflow-y: auto;
  max-height: 140px; /* Adjustable height */
  line-height: 1.6;
  scroll-behavior: smooth;
  }
  .typed { color: var(--muted); text-decoration: none; }
  .current { background: color-mix(in oklab, var(--brand) 20%, transparent 80%); outline: 2px solid color-mix(in oklab, var(--brand) 45%, transparent 55%); border-radius: 6px; }
  .wrong { background: color-mix(in oklab, var(--bad) 25%, transparent 75%); text-decoration: underline wavy var(--bad); border-radius: 6px; }

  textarea.input {
     width: 100%;
  height: 110px;
  resize: none;
  font: 16px/1.5 ui-monospace, "SF Mono", Menlo, Consolas, monospace;
  background: var(--bg-soft);
  color: var(--text);
  border: 1px solid var(--key-border);
  border-radius: 12px;
  padding: 12px;
  white-space: pre-wrap;
  overflow-y: auto;
  word-wrap: break-word;
    background: var(--bg-soft); color: var(--text); border: 1px solid var(--key-border); border-radius: 12px; padding: 12px;
  }

  /* Stats */
  .stats { display:grid; grid-template-columns: repeat(6, 1fr); gap:10px; }
  @media (max-width: 680px) { .stats { grid-template-columns: repeat(3, 1fr); } }
  .stat {
    background: var(--bg-soft); border:1px solid var(--key-border); border-radius: 12px; padding: 12px; text-align:center;
  }
  .stat .val { font-size: 24px; font-weight: 800; }
  .good { color: var(--good); }
  .bad { color: var(--bad); }
  .warn { color: var(--warn); }

  /* Virtual keyboard */
  .vk-wrap { display:flex; flex-direction:column; gap:10px; }
  .vk { user-select:none; }
  .krow { display:flex; gap:6px; margin-bottom:6px; }
  .key {
    background: var(--key);
    border:1px solid var(--key-border);
    border-bottom-width: 3px;
    color: var(--key-text);
    border-radius: 10px; padding: 10px 8px; min-width: 38px; text-align:center;
    font-weight: 700; letter-spacing: .2px; position: relative;
    transition: transform .06s ease, filter .2s ease;
  }
  .key.small { min-width: 30px; padding: 8px 6px; font-weight: 600; }
  .key.wide { min-width: 76px; }
  .key.xwide { min-width: 96px; }
  .key.space { min-width: 280px;background: 
 color-mix(in oklab, rgb(54, 52, 63) 50%, var(--key)); }
  .key.active { transform: translateY(2px); border-bottom-width: 1px; }
  .key.expected { outline: 2px solid var(--brand); z-index: 1; }
  .key::after {
    content: attr(data-hit);
    position: absolute; right: 6px; bottom: 2px; font-size: 10px; color: var(--muted);
  }
  .altleft , .altright {
    min-width: 100px;background: 
 color-mix(in oklab, rgb(54, 52, 63) 50%, var(--key));
  }

  /* Finger color legend (background tints) */
  .pink { background: color-mix(in oklab, rgb(255, 0, 136) 50%, var(--key)); }
  .red { background: color-mix(in oklab, rgb(255, 0, 0) 50%, var(--key)); }
  .orange { background: color-mix(in oklab, rgb(255, 140, 0) 50%, var(--key)); }
  .yellow { background: color-mix(in oklab, rgb(255, 238, 0) 50%, var(--key)); }
  .green { background: color-mix(in oklab, rgb(26, 231, 115) 50%, var(--key)); }
  .cyan { background: color-mix(in oklab, rgb(3, 85, 85) 50%, var(--key)); }
  .blue { background: color-mix(in oklab, rgb(0, 64, 255) 50%, var(--key)); }
  .purple { background: color-mix(in oklab, rgb(183, 0, 255) 50%, var(--key)); }
  .grey { background: color-mix(in oklab, rgb(136, 137, 147) 50%, var(--key)); }

  /* Footer */
  footer {
    margin-top: 20px; padding: 18px; background: var(--card); border:1px solid var(--key-border); border-radius: 16px;
    display:flex; flex-wrap: wrap; align-items:center; gap:12px; justify-content: space-between;
  }
  .socials { display:flex; gap:10px; flex-wrap:wrap; }
  .socials a { background: var(--bg-soft); border:1px solid var(--key-border); padding:8px 10px; border-radius: 999px; font-weight: 600; }

  .legend { display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
  .legend .dot { width:14px; height:14px; border-radius: 3px; display:inline-block; border:1px solid var(--key-border); }
  

  header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  position: sticky;
  top: 0;
  z-index: 50;
  background: var(--bg); /* Changed from gradient */
  padding-block: 8px 6px;
}
.site-header{
  background: var(--bg);
  border-bottom: 1px solid var(--c-border);
  padding: 12px 16px;
  display:flex; align-items:center; gap:12px; flex-wrap:wrap;
}
.site-footer{
  border-bottom: 1px solid var(--c-border);
  padding: 12px 16px;
  display:flex; align-items:center; gap:12px; flex-wrap:wrap;
}
h1 {
    display: flex
;
    width: 588px;
    height: 88px;
    flex-direction: column;
    justify-content: center;
    flex-shrink: 0;
    margin-bottom: 10px;
    color: #000;
    text-align: center;
    font-feature-settings: 'liga' off, 'clig' off;
    font-family: "Nico Moji";
    font-size: 40px;
    font-style: normal;
    font-weight: 400;
    line-height: 100%;
    letter-spacing: -0.64px;
}
.site-footer{ border-bottom:none; justify-content:center; text-align: center;}

.site-header h1{margin:0}
.nav{display:flex; gap:10px; flex:1 1 auto}
.nav a{color:var(--fg); text-decoration:none; padding:6px 10px; border-radius:8px}
.nav a.active, .nav a:hover{background:rgba(58,122,254,0.12)}

body.dark {
    --bg: #0f1226;
    --fg: #e6e9f8;
    --panel: #171a31;
    --c-border: #232746;
    --c-muted: #98a2b3;
    --key-bg: #1f2342;
    --key-fg: #e6e9f8;
    --accent: #7aa2ff;
}
:root {
  --h1-color: var(--text);
}

[data-theme="light"] {
  --h1-color: var(--text);
}
[data-theme="dark"] {
  --h1-color: var(--brand);
}

.site-header h1 {
  margin: 0;;
  color: var(--h1-color);
  transition: color 0.3s, text-shadow 0.3s;
}
.nav a {
  color: var(--text);
  text-decoration: none;
  padding: 6px 10px;
  border-radius: 8px;
}
.nav a.active,
.nav a:hover {
  background: color-mix(in oklab, var(--brand) 20%, transparent 80%);
}
.key:hover { filter: brightness(1.15); }
 
.prompt {
  flex-direction: column;
  align-items: stretch;
  width: 100%; /* matches parent width */
  max-width: 810px; /* set your desired width */
  

}
.social-links {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    justify-content: center;
}
.red-youtube {
            color: red;
            font-size: 36px;
        }
.blue-linkedin {
            color: rgb(0, 119,181);
            font-size: 36px;
        }
.red-reddit {
            color: rgb(255, 69, 0);
            font-size: 36px;
        }
.red-treads {
            color: rgb(16, 24, 32);
            font-size: 36px;
        }
.red-facebook {
            color: rgb(24, 119, 242);
            font-size: 36px;
        }
.red-twitter {
            color: rgb(29, 155, 240);
            font-size: 36px;
            width:30px;
        }
.red-tiktok {
            color: rgb(0, 0, 0);
            font-size: 36px;
        }

header img#logoImg {
  height: 60px;   /* adjust as needed */
  width: auto;
  transition: filter 0.3s ease-in-out;
}
.logo-container {
  flex: 1;                     /* take full width */
  display: flex;
  justify-content: center;      /* center horizontally */
  align-items: center;          /* center vertically */
}


  </style>
</head>
<body>
  <header class="site-header">
  <!-- Instead of <h1> -->
    <!--
  
  
  <button id="themeToggle">🌙</button>

  
    <h1>Typing Tutor</h1> -->
    <div class="logo-container">
    <img id="logoImg" src="instagramlogo.png" alt="Typing Tutor Logo" />
    </div>
    <div class="controls">
        <label class="toggle" title="Dark / Light">
          <input id="themeToggle" type="checkbox" checked />
          <span>🌙 Dark</span>
        </label>
        <label class="toggle" title="Show/Hide Virtual Keyboard">
          <input id="kbdToggle" type="checkbox" checked />
          <span>⌨️ Keyboard</span>
        </label>
    </div>
       
    
  </header>
   <main class="grid">
      <!-- LEFT: Test -->
      <section class="card">
        <h2>Typing Test</h2>

        <div class="row" style="margin-bottom:8px;">
          <label class="pill">Level
            <select id="level">
              <option value="beginner">Beginner</option>
              <option value="intermediate">Intermediate</option>
              <option value="advanced">Advanced</option>
            </select>
          </label>

          <label class="pill">Time
            <select id="timeSelect">
              <option value="30">30s</option>
              <option value="60" selected>60s</option>
              <option value="120">120s</option>
            </select>
          </label>

          <div class="spacer"></div>

          <button id="startBtn" class="btn">Start</button>
          <button id="resetBtn" class="btn secondary" disabled>Reset</button>
          <button id="restartBtn" class="btn ghost" disabled>Restart</button>
        </div>

        <div id="prompt" class="prompt" aria-live="polite"></div>

        <div class="row" style="margin:10px 0;">
          <div class="legend" title="Finger color guide">
            <span class="dot pink"></span><small>Left little</small>
            <span class="dot red"></span><small>Left ring</small>
            <span class="dot orange"></span><small>Left middle</small>
            <span class="dot yellow"></span><small>Left index</small>
            <span class="dot green"></span><small>Right index</small>
            <span class="dot cyan"></span><small>Right middle</small>
            <span class="dot blue"></span><small>Right ring</small>
            <span class="dot purple"></span><small>Right little</small>
            <span class="dot grey"></span><small>thump</small>
          </div>
          <div class="spacer"></div>
          <div class="pill">Time left: <strong id="timeLeft" style="margin-left:6px;">60</strong>s</div>
        </div>

        <textarea id="typingArea" class="input" placeholder="Click Start, then type here…" disabled placeholder="Start typing here…" 
          onpaste="return false" 
          ondrop="return false" 
          oncopy="return false" 
          oncut="return false" 
          oncontextmenu="return false"></textarea>

        <div class="stats" style="margin-top: 12px;">
          <div class="stat"><div class="lbl">WPM</div><div id="statWpm" class="val good">0</div></div>
          <div class="stat"><div class="lbl">Accuracy</div><div id="statAcc" class="val warn">100%</div></div>
          <div class="stat"><div class="lbl">Errors</div><div id="statErr" class="val bad">0</div></div>
          <div class="stat"><div class="lbl">Attempts</div><div id="statAttempts" class="val">0</div></div>
          <div class="stat"><div class="lbl">Best</div><div id="statBest" class="val good">0</div></div>
          <div class="stat"><div class="lbl">Average</div><div id="statAvg" class="val">0</div></div>
        </div>

        <div class="vk-wrap" style="margin-top:14px;">
          <div id="virtualKeyboard" class="vk"></div>
          <small style="color:var(--muted);">Per-key heatmap is shown as intensity on each key (value in the corner). It updates as you type.</small>
        </div>
      </section>

      <!-- RIGHT: Tips / Help -->
      <aside class="card1">
        <h2>Tips</h2>
        <ul style="line-height:1.7; margin-top:10px; color: var(--muted);">
          <li>Place your fingers on the home row: <b>ASDF</b> (left) and <b>JKL;</b> (right).</li>
          <li>Keep wrists straight, eyes on the screen, not the keyboard.</li>
          <li>Focus on <b>accuracy</b> first—speed will follow.</li>
          <li>Use the <b>Virtual Keyboard</b> to learn correct finger usage (colors).</li>
          <li>Dark/Light mode toggle is at the top right.</li>
        </ul>
        <hr style="border:none;border-top:1px solid var(--key-border); margin:14px 0;">
        <h2>Session Summary</h2>
        <div style="color:var(--muted); font-size:14px;">
          After each test, your <b>WPM</b> is saved locally. Best, attempts, and average update automatically.
          You can clear site data anytime from your browser settings.
        </div>
      </aside>
    </main>
  

  <footer class="site-footer">
    <div class="container footer-content">
            <div class="contact-info">
                <p>Made with ❤️ for fast & accurate typing.</p>
                <p>Have questions or need help? Reach out to our support team</p>
                <p><i class="fas fa-envelope"></i> <a href="mailto:freetypingtutor@gmail.com">freetypingtutor@gmail.com</a></p>
            </div>
            
            <div class="social-links">
                <a href="#" target="_blank"><img src="youtubelogo.png" alt="youtube Logo" style="width:30px;"></a>
                <a href="#" target="_blank"><img src="Facebooklogo.png" alt="facebook Logo" style="width:30px;"></a>
                <a href="#" target="_blank"><img src="redditlogo.png" alt="redditlogo Logo" style="width:30px;"></a>
                <a href="#" target="_blank"><img src="instagramlogo.png" alt="Instagram Logo" style="width:30px;"></a>
                <a href="#" target="_blank"><img src="threadslogo.png" alt="threads Logo" style="width:30px;height: 30px;border-radius: 8px;"></a>
                <a href="#" target="_blank"><img src="linkedinlogo.png" alt="linkedin Logo" style="width:30px;"></a>
                <a href="#" target="_blank"><img src="twitter-xlogo.png" alt="twitter-x Logo" style="width:30px;"></a>
                <a href="#" target="_blank"><img src="tiktoklogo.png" alt="tiktok Logo" style="width:30px;"></a>
            </div>
            
            <div class="copyright">
                <p>&copy; 2025 Typingtutor. All rights reserved.</p>
            </div>
        </div>
  </footer>

  <script src="util.js"></script>
  <script src="keyboard.js"></script>
  <script>
   
"use strict";

/* ---------- Utilities ---------- */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const LSK = {
  attempts: 'tt.attempts',
  best: 'tt.best',
  history: 'tt.history',
  heatmap: 'tt.heatmap',
  theme: 'tt.theme',
  logo: 'tt.logo'
};

/* ---------- Logo upload ---------- */
(function logoLoader(){
  const file = $('#logoFile');
  const img = $('#logoImg');
  const saved = localStorage.getItem(LSK.logo);
  if(saved){ img.src = saved; }
  file?.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      img.src = ev.target.result;
      localStorage.setItem(LSK.logo, ev.target.result);
    };
    reader.readAsDataURL(f);
  });
})();

/* ---------- Theme toggle ---------- */
/*
(function themeInit(){
  const toggle = $('#themeToggle');
  const saved = localStorage.getItem(LSK.theme) || 'dark';
  document.body.setAttribute('data-theme', saved);
  toggle.checked = saved === 'dark';
  toggle.addEventListener('change', ()=>{
    const mode = toggle.checked ? 'dark' : 'light';
    document.body.setAttribute('data-theme', mode);
    localStorage.setItem(LSK.theme, mode);
  });
})();*/
(function themeInit(){
  const toggle = $('#themeToggle');
  const logoImg = $('#logoImg');

  function updateLogo(mode){
    if(mode === 'dark'){
      logoImg.src = "typingtutordark.png";   // your dark version
    } else {
      logoImg.src = "typingtutorlight.png";  // your light version
    }
  }

  // Load saved theme
  const saved = localStorage.getItem(LSK.theme) || 'dark';
  document.body.setAttribute('data-theme', saved);
  toggle.checked = saved === 'dark';
  updateLogo(saved);

  // Listen for changes
  toggle.addEventListener('change', ()=>{
    const mode = toggle.checked ? 'dark' : 'light';
    document.body.setAttribute('data-theme', mode);
    localStorage.setItem(LSK.theme, mode);
    updateLogo(mode);
  });
})();


/* ---------- Sample content pools ---------- */
const WORDS = {
  beginner: "the be to of and a in that have I it for not on with he as you do at this but his by from".split(' '),
  intermediate: "keyboard lesson accuracy practice rhythm typing student speed improve correct balance focus posture".split(' '),
  advanced: "synchronous algorithmic polymorphism encapsulation optimization virtualization concurrency ergonomic proprioception".split(' ')
};
const SENTENCES = {
  beginner: [
    "Keep your fingers on the home row keys.",
    "Type slow and steady to avoid mistakes.",
    "Use the correct finger for each key.",
    "Look at the screen not the keyboard.",
    "Practice a little every single day.",
    "Relax your shoulders and breathe."
  ],
  intermediate: [
    "Accuracy builds confidence, then speed follows naturally.",
    "Rhythm and posture matter for long typing sessions.",
    "Short bursts of focused practice beat long distracted ones.",
    "Use all ten fingers to reduce strain and increase speed.",
    "Consistent technique makes progress sustainable.",
    "Learn common word patterns to type faster."
  ],
  advanced: [
    "Muscle memory emerges from deliberate, attentive repetition.",
    "Maintain minimal finger travel to optimize efficiency.",
    "Ergonomic alignment reduces fatigue and errors over time.",
    "Cognitive load drops when movement patterns are automated.",
    "Chunk words and phrases to accelerate overall throughput.",
    "Anticipate punctuation and capitalization smoothly."
  ]
};

function genText(level){
  // mix of a sentence plus random words for variety
  const sent = SENTENCES[level][Math.floor(Math.random()*SENTENCES[level].length)];
  const w = [...WORDS[level]];
  w.sort(()=>Math.random()-0.5);
  return `${sent} ${w.slice(0, 18).join(' ')}.`;
}

/* ---------- Virtual keyboard ---------- */
const layout = [
  ['`','1','2','3','4','5','6','7','8','9','0','-','=','Backspace'],
  ['Tab','q','w','e','r','t','y','u','i','o','p','[',']','\\'],
  ['CapsLock','a','s','d','f','g','h','j','k','l',';',"'",'Enter'],
  ['ShiftLeft','z','x','c','v','b','n','m',',','.','/','ShiftRight'],
  ['Control','AltLeft','Space','AltRight','Meta','ContextMenu']
];
const fingerClasses = {
  '`':'pink','1':'pink','2':'red','3':'orange','4':'yellow','5':'yellow','6':'green','7':'green','8':'cyan','9':'blue','0':'purple','-':'purple','=':'purple','Backspace':'purple',
  'Tab':'pink','q':'pink','w':'red','e':'orange','r':'yellow','t':'yellow','y':'green','u':'green','i':'cyan','o':'blue','p':'purple','[':'purple',']':'purple','\\':'purple',
  'CapsLock':'pink','a':'pink','s':'red','d':'orange','f':'yellow','g':'yellow','h':'green','j':'green','k':'cyan','l':'blue',';':'purple',"\'":'purple','Enter':'purple',
  'ShiftLeft':'pink','z':'pink','x':'red','c':'orange','v':'yellow','b':'yellow','n':'green','m':'green',',':'cyan','.':'blue','/':'purple','ShiftRight':'purple',
  'Control':'pink','AltLeft':'red','Space':'grey','AltRight':'cyan','Meta':'blue','ContextMenu':'purple'
};

function buildKeyboard(container){
  container.innerHTML = '';
  layout.forEach(row=>{
    const r = document.createElement('div'); r.className = 'krow';
    row.forEach(k=>{
      const d = document.createElement('div');
      const cls = (k==='Backspace'?'xwide':k==='CapsLock'||k==='Enter'||k==='Tab'?'wide':k==='ShiftLeft'||k==='ShiftRight'?'xwide':k==='Space'?'space':'');
      d.className = `key ${cls} ${fingerClasses[k]||''}`;
      d.dataset.key = k;
      d.textContent = (k.length>1)
        ? (k==='Backspace'?'⌫':k==='ShiftLeft'||k==='ShiftRight'?'Shift':k==='AltLeft'||k==='AltRight'?'Alt':k==='Meta'?'Meta':k==='ContextMenu'?'Menu':k)
        : k;
      r.appendChild(d);
    });
    container.appendChild(r);
  });
}

function loadHeatmap(){ return JSON.parse(localStorage.getItem(LSK.heatmap) || '{}'); }
function saveHeatmap(map){ localStorage.setItem(LSK.heatmap, JSON.stringify(map)); }
function bumpHeat(key){
  const map = loadHeatmap();
  map[key] = (map[key]||0) + 1;
  saveHeatmap(map);
  shadeKeys(map);
}
function shadeKeys(map){
  const max = Math.max(1, ...Object.values(map));
  $$('.key', $('#virtualKeyboard')).forEach(el=>{
    const v = map[el.dataset.key]||0;
    const t = v ? Math.min(0.8, v/max*0.8) : 0;
    el.style.filter = t ? `brightness(${1 - t*0.35}) saturate(${1 + t})` : 'none';
    el.setAttribute('data-hit', v ? String(v) : '');
  });
}
function setExpectedKey(ch){
  $$('.key', $('#virtualKeyboard')).forEach(el=>el.classList.remove('expected'));
  const t = ch===' ' ? 'Space' : (ch||'').toLowerCase();
  if(!t) return;
  const el = $(`.key[data-key="${CSS.escape(t)}"]`, $('#virtualKeyboard'));
  if(el) el.classList.add('expected');
}

/* ---------- Stats persistence ---------- */
function getAttempts(){ return Number(localStorage.getItem(LSK.attempts) || '0'); }
function setAttempts(n){ localStorage.setItem(LSK.attempts, String(n)); }
function getBest(){ return Number(localStorage.getItem(LSK.best) || '0'); }
function setBest(n){ localStorage.setItem(LSK.best, String(n)); }
function getHistory(){ return JSON.parse(localStorage.getItem(LSK.history) || '[]'); }
function pushHistory(rec){
  const hist = getHistory();
  hist.push(rec);
  localStorage.setItem(LSK.history, JSON.stringify(hist));
}

/* ---------- Test state ---------- */
const levelSel = $('#level');
const timeSel = $('#timeSelect');
const promptEl = $('#prompt');
const area = $('#typingArea');
// Block paste/insert via keyboard too
area.addEventListener("paste", (e) => {
  e.preventDefault();
  return false;
});
area.addEventListener("drop", (e) => {
  e.preventDefault();
  return false;
});

const startBtn = $('#startBtn');
const resetBtn = $('#resetBtn');
const restartBtn = $('#restartBtn');
const timeLeftEl = $('#timeLeft');
const kbdToggle = $('#kbdToggle');
const vk = $('#virtualKeyboard');

const wpmEl = $('#statWpm');
const accEl = $('#statAcc');
const errEl = $('#statErr');
const attemptsEl = $('#statAttempts');
const bestEl = $('#statBest');
const avgEl = $('#statAvg');

let targetText = '';
let timer = null;
let startedAt = 0;
let seconds = 60;
let typedChars = 0;
let correctChars = 0;
let errors = 0;
let ended = false;

function renderPrompt(){
  const typed = area.value;
  let out = '';
  for(let i=0;i<targetText.length;i++){
    const ch = targetText[i];
    if(i < typed.length){
      const ok = typed[i] === ch;
      out += `<span class="${ok ? 'typed' : 'wrong'}">${ch === ' ' ? '␣' : escapeHTML(ch)}</span>`;
    } else if(i === typed.length){
      out += `<span class="current">${ch === ' ' ? '␣' : escapeHTML(ch)}</span>`;
    } else {
      out += escapeHTML(ch);
    }
  }
  promptEl.innerHTML = out;
  setExpectedKey(targetText[typed.length] || '');
  const currentEl = promptEl.querySelector('.current');
if (currentEl) {
  const promptRect = promptEl.getBoundingClientRect();
  const currentRect = currentEl.getBoundingClientRect();
  const offset = currentRect.top - promptRect.top;
  
  // If the current line is beyond half the prompt box, scroll
  if (offset > promptEl.clientHeight * 0.5 || offset < 0) {
    currentEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

}
function escapeHTML(s){ return s.replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }

function computeStats(){
  const elapsedMin = Math.max(0.001, (Date.now() - startedAt) / 60000);
  const wpm = Math.round((correctChars/5) / elapsedMin);
  const acc = typedChars ? Math.round((correctChars/typedChars)*100) : 100;
  return { wpm, acc, errors };
}


function updateHeaderStatsFromStorage(){
  attemptsEl.textContent = String(getAttempts());
  bestEl.textContent = String(getBest());
  const hist = getHistory();
  const avg = hist.length ? Math.round(hist.reduce((a,b)=> a + (b.wpm||0), 0) / hist.length) : 0;
  avgEl.textContent = String(avg);
}

function startTest(){
  // init
  seconds = Number(timeSel.value||60);
  timeLeftEl.textContent = String(seconds);
  targetText = genText(levelSel.value);
  area.value = '';
  typedChars = 0; correctChars = 0; errors = 0; ended = false;
  restartBtn.disabled = false;


  renderPrompt();
  area.disabled = false; area.focus();
  startBtn.disabled = true; resetBtn.disabled = false;
  startedAt = Date.now();
  updateStatsUI();

  clearInterval(timer);
  timer = setInterval(()=>{
    seconds -= 1;
    timeLeftEl.textContent = String(seconds);
    updateStatsUI();
    if(seconds <= 0){ endTest(); }
  }, 1000);
}
function endTest(){
  if(ended) return;
  ended = true;
  clearInterval(timer);
  area.disabled = true;
  const { wpm } = computeStats();
  // persist
  const newAttempts = getAttempts()+1; setAttempts(newAttempts);
  const prevBest = getBest(); if(wpm > prevBest) setBest(wpm);
  pushHistory({ ts: Date.now(), wpm, acc: computeStats().acc, errors });
  updateHeaderStatsFromStorage();

  startBtn.disabled = false; resetBtn.disabled = false;
}
function resetTest(){
  clearInterval(timer);
  timeLeftEl.textContent = String(timeSel.value);
  area.value = '';
  typedChars = correctChars = errors = 0;
  ended = false;
  


  // Clear all localStorage related to the app
  localStorage.removeItem(LSK.attempts);
  localStorage.removeItem(LSK.best);
  localStorage.removeItem(LSK.history);
  localStorage.removeItem(LSK.heatmap);

  // Rebuild keyboard and stats
  shadeKeys({});
  updateHeaderStatsFromStorage();

  startBtn.disabled = false;
  resetBtn.disabled = true;
  targetText = genText(levelSel.value);
  renderPrompt();
  updateStatsUI();
}


function restartTest() {
  clearInterval(timer); // stop current timer

  // Reset test state (but NOT stats)
  seconds = Number(timeSel.value || 60);
  timeLeftEl.textContent = String(seconds);
  targetText = genText(levelSel.value);
  area.value = '';
  typedChars = 0;
  correctChars = 0;
  errors = 0;
  ended = false;

  renderPrompt();
  area.disabled = false;
  area.focus();

  startedAt = Date.now();
  updateStatsUI();

  // Restart timer
  timer = setInterval(() => {
    seconds -= 1;
    timeLeftEl.textContent = String(seconds);
    updateStatsUI();
    if (seconds <= 0) {
      endTest();
    }
  }, 1000);

  // Buttons state
  startBtn.disabled = true;
  resetBtn.disabled = false;
  restartBtn.disabled = false;
}


area.addEventListener('input', ()=>{
  const typed = area.value;
  // update counters based on new char only
  const last = typed[typed.length-1];
  if(last !== undefined){
    typedChars++;
    if(last === targetText[typed.length-1]) correctChars++; else errors++;
    bumpHeat(last === ' ' ? 'Space' : (last||'').toLowerCase());
  }
  renderPrompt();
  updateStatsUI();
  if(typed.length >= targetText.length){
    // extend text gently for continuous typing
    targetText += ' ' + genText(levelSel.value);
    renderPrompt();
  }
});
area.addEventListener('keydown', (e)=>{
  // highlight pressed key
  const codeMap = {
    ' ': 'Space'
  };
  const key = codeMap[e.key] || e.key?.toLowerCase();
  const el = $(`.key[data-key="${CSS.escape(key)}"]`, vk);
  if(el){ el.classList.add('active'); setTimeout(()=>el.classList.remove('active'), 90); }
});

startBtn.addEventListener('click', startTest);
resetBtn.addEventListener('click', resetTest);
restartBtn.addEventListener('click', restartTest);


kbdToggle.addEventListener('change', ()=>{
  $('#virtualKeyboard').style.display = kbdToggle.checked ? 'block' : 'none';
});

/* ---------- Init ---------- */
(function init(){
  buildKeyboard(vk);
  shadeKeys(loadHeatmap());
  updateHeaderStatsFromStorage();
  targetText = genText(levelSel.value);
  renderPrompt();
  timeLeftEl.textContent = String(timeSel.value);
})();

(function themeInit(){
  const toggle = $('#themeToggle');
  const h1 = document.querySelector('.site-header h1');

  const saved = localStorage.getItem('theme') || 'dark';
  setTheme(saved);

  toggle.checked = (saved === 'dark');

  toggle.addEventListener('change', ()=>{
    setTheme(toggle.checked ? 'dark' : 'light');
  });

  function setTheme(mode){
    document.body.dataset.theme = mode;
    localStorage.setItem('theme', mode);

    // Update H1 style simultaneously
    if(mode === 'dark'){
      h1.style.color = getComputedStyle(document.body).getPropertyValue('--brand').trim();
      h1.style.textShadow = "0 0 6px var(--brand)";
    } else {
      h1.style.color = getComputedStyle(document.body).getPropertyValue('--text').trim();
      h1.style.textShadow = "none";
    }
  }
})();

if(typed.length >= targetText.length){
  endTest();
}

function updateStatsUI() {
  const { wpm, acc, errors: err } = computeStats();

  wpmEl.textContent = String(wpm);
  accEl.textContent = `${acc}%`;
  errEl.textContent = String(err);

  // Optional: adjust color classes
  accEl.className = 'val ' + (acc >= 95 ? 'good' : acc >= 80 ? 'warn' : 'bad');
  wpmEl.className = 'val ' + (wpm >= 50 ? 'good' : wpm >= 30 ? 'warn' : 'bad');
  errEl.className = 'val ' + (err <= 2 ? 'good' : err <= 5 ? 'warn' : 'bad');
}
/*
const logoImg = document.getElementById("logoImg");

function updateLogo() {
  if (document.body.classList.contains("dark-mode")) {
    logoImg.src = "logo-dark.png";   // dark theme logo
  } else {
    logoImg.src = "logo-light.png";  // light theme logo
  }
}

// Call on page load
updateLogo();
*/
// Also call when theme toggles
themeBtn.addEventListener("click", updateLogo);


const logoImg = document.getElementById("logoImg");

function updateLogo() {
  if (document.body.classList.contains("dark-mode")) {
    logoImg.src = "logo-dark.png";   // dark version
  } else {
    logoImg.src = "logo-light.png";  // light version
  }
}

// run once on page load
updateLogo();

// whenever theme button is clicked, update theme + logo
themeBtn.addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
  localStorage.setItem(
    "theme",
    document.body.classList.contains("dark-mode") ? "dark" : "light"
  );
  updateLogo();
});

  </script>
</body>
</html>     


